{% extends "base.html" %}

{% block title %}Token Issued — ANLA Admin{% endblock %}

{% block content %}
<h1>Token Issued</h1>

<div class="card">
  <p style="margin-bottom: 0.75rem;">
    <strong>Device:</strong> {{ device_name or device_uuid }}
  </p>
  <p style="margin-bottom: 0.75rem;">
    <strong>Action:</strong> {{ action }}
  </p>

  <div style="background: rgba(251,191,36,0.1); border: 1px solid var(--yellow); border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem;">
    <p style="color: var(--yellow); font-size: 0.85rem; font-weight: 600;">⚠️ Copy this token now — or scan the QR code. It will not be shown again.</p>
  </div>

  <div style="display: flex; gap: 1.5rem; align-items: flex-start; flex-wrap: wrap;">
    <div style="flex: 1; min-width: 250px;">
      <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.4rem;">Bearer Token</p>
      <div class="token-box">{{ token }}</div>
    </div>
    <div style="flex-shrink: 0; text-align: center;">
      <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.4rem;">Scan with device</p>
      <canvas id="qr-canvas" style="border-radius: 8px; background: #fff; padding: 12px;"></canvas>
    </div>
  </div>
</div>

<p class="mt-2"><a href="/admin/devices/{{ device_id }}" class="btn btn-primary">Continue to Device</a></p>

<script>
// Minimal QR Code generator (QR Code Model 2, alphanumeric/byte mode)
// Self-contained — no external dependencies
(function(){
  // qrcode-generator v1.4.4 (MIT) — minified core
  // Source: https://github.com/kazuhikoarase/qrcode-generator
  var qrcode=function(){var f=function(a,c){var b=a,d=g[c],e=null,h=0,m=null,n=[],p={},q=function(a,c){e=function(a){for(var c=Array(a),b=0;b<a;b+=1){c[b]=Array(a);for(var d=0;d<a;d+=1)c[b][d]=null}return c}(h=4*b+17);r(0,0);r(h-7,0);r(0,h-7);t();u();v(a,c);7<=b&&w(a);null==m&&(m=x(b,d,n));y(m,c)},r=function(a,b){for(var c=-1;7>=c;c+=1)if(!(-1>=a+c||h<=a+c))for(var d=-1;7>=d;d+=1)-1>=b+d||h<=b+d||(e[a+c][b+d]=0<=c&&6>=c&&(0==d||6==d)||0<=d&&6>=d&&(0==c||6==c)||2<=c&&4>=c&&2<=d&&4>=d?!0:!1)},t=function(){for(var a=8;a<h-8;a+=1)null==e[a][6]&&(e[a][6]=0==a%2),null==e[6][a]&&(e[6][a]=0==a%2)},u=function(){for(var a=k.getPatternPosition(b),c=0;c<a.length;c+=1)for(var d=0;d<a.length;d+=1){if(null!=e[a[c]][a[d]])continue;for(var f=-2;2>=f;f+=1)for(var g=-2;2>=g;g+=1)e[a[c]+f][a[d]+g]=-2==f||2==f||-2==g||2==g||0==f&&0==g?!0:!1}},v=function(a,b){for(var c=d<<3|b,f=k.getBCHTypeInfo(c),g=0;15>g;g+=1){var l=!a&&1==(f>>g&1);6>g?e[g][8]=l:8>g?e[g+1][8]=l:e[h-15+g][8]=l}for(g=0;15>g;g+=1)l=!a&&1==(f>>g&1),8>g?e[8][h-g-1]=l:9>g?e[8][15-g-1+1]=l:e[8][15-g-1]=l;e[h-8][8]=!a},w=function(a){for(var c=k.getBCHTypeNumber(b),d=0;18>d;d+=1){var f=!a&&1==(c>>d&1);e[Math.floor(d/3)][d%3+h-8-3]=f}for(d=0;18>d;d+=1)f=!a&&1==(c>>d&1),e[d%3+h-8-3][Math.floor(d/3)]=f},y=function(a,b){for(var c=-1,d=h-1,f=7,g=0,l=k.getMaskFunction(b),m=h-1;0<m;m-=2)for(6==m&&(m-=1);;){for(var n=0;2>n;n+=1)null==e[d][m-n]&&(p=!1,g<a.length&&(p=1==(a[g]>>>f&1)),l(d,m-n)&&(p=!p),e[d][m-n]=p,-1==--f&&(g+=1,f=7));d+=c;if(0>d||h<=d){d-=c;c=-c;break}}},x=function(a,b,c){for(var d=A.getRSBlocks(a,b),e=B(),f=0;f<c.length;f+=1){var g=c[f];e.put(g.getMode(),4);e.put(g.getLength(),k.getLengthInBits(g.getMode(),a));g.write(e)}for(a=f=0;a<d.length;a+=1)f+=d[a].dataCount;if(e.getLengthInBits()>8*f)throw Error("code length overflow. ("+e.getLengthInBits()+">"+8*f+")");for(e.getLengthInBits()+4<=8*f&&e.put(0,4);0!=e.getLengthInBits()%8;)e.putBit(!1);for(;!(e.getLengthInBits()>=8*f);)e.put(236,8),e.getLengthInBits()>=8*f||e.put(17,8);return C(e,d)},C=function(a,b){for(var c=0,d=0,e=0,f=Array(b.length),g=Array(b.length),h=0;h<b.length;h+=1){var l=b[h].dataCount,m=b[h].totalCount-l;d=Math.max(d,l);e=Math.max(e,m);f[h]=Array(l);for(var n=0;n<f[h].length;n+=1)f[h][n]=255&a.getBuffer()[n+c];c+=l;n=k.getErrorCorrectPolynomial(m);l=D(f[h],n.getLength()-1).mod(n);g[h]=Array(n.getLength()-1);for(n=0;n<g[h].length;n+=1)m=n+l.getLength()-g[h].length,g[h][n]=0<=m?l.getAt(m):0}for(n=a=0;n<b.length;n+=1)a+=b[n].totalCount;a=Array(a);for(n=c=0;n<d;n+=1)for(h=0;h<b.length;h+=1)n<f[h].length&&(a[c]=f[h][n],c+=1);for(n=0;n<e;n+=1)for(h=0;h<b.length;h+=1)n<g[h].length&&(a[c]=g[h][n],c+=1);return a};p.addData=function(a,b){b=b||"Byte";if("Byte"==b)a=E(a);else throw"unsupported mode: "+b;n.push(a);m=null};p.isDark=function(a,b){if(0>a||h<=a||0>b||h<=b)throw Error(a+","+b);return e[a][b]};p.getModuleCount=function(){return h};p.make=function(){if(1>b){for(var a=1;a<40;a+=1){for(var c=A.getRSBlocks(a,d),e=B(),f=0;f<n.length;f+=1){var g=n[f];e.put(g.getMode(),4);e.put(g.getLength(),k.getLengthInBits(g.getMode(),a));g.write(e)}for(c=f=0;c<c.length;c+=1)f+=c[c].dataCount;if(e.getLengthInBits()<=8*f)break}b=a}q(!1,F(b))};p.createSvgTag=function(a,b){var c={};a="number"==typeof a?(c.cellSize=a,"number"==typeof b&&(c.margin=b),c):a||c;a=a.cellSize||2;b=("undefined"==typeof a.margin?4*a:a.margin);var d=p.getModuleCount()*a+2*b,e="";e+='<svg version="1.1" xmlns="http://www.w3.org/2000/svg"';e+=' width="'+d+'px" height="'+d+'px"';e+=">";e+='<rect width="100%" height="100%" fill="white" />';for(var f=0;f<p.getModuleCount();f+=1)for(var g=0;g<p.getModuleCount();g+=1)p.isDark(f,g)&&(e+='<rect x="'+(g*a+b)+'" y="'+(f*a+b)+'" width="'+a+'" height="'+a+'" fill="black" />');e+="</svg>";return e};p.renderTo2dContext=function(a,b){b=b||2;for(var c=p.getModuleCount(),d=0;d<c;d++)for(var e=0;e<c;e++)a.fillStyle=p.isDark(d,e)?"#000":"#fff",a.fillRect(e*b,d*b,b,b)};return p};f.stringToBytesFuncs={"default":function(a){for(var c=[],b=0;b<a.length;b+=1){var d=a.charCodeAt(b);128>d?c.push(d):2048>d?c.push(192|d>>6,128|63&d):55296<=d&&57344>d?(b++,d=65536+((1023&d)<<10|1023&a.charCodeAt(b)),c.push(240|d>>18,128|d>>12&63,128|d>>6&63,128|63&d)):c.push(224|d>>12,128|d>>6&63,128|63&d)}return c}};f.stringToBytes=f.stringToBytesFuncs["default"];var E=function(a){var c={getMode:function(){return 4},getLength:function(b){return f.stringToBytes(a).length},write:function(b){for(var c=f.stringToBytes(a),d=0;d<c.length;d+=1)b.put(c[d],8)}};return c},g={L:1,M:0,Q:3,H:2},k=function(){var a=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],c={},b=function(a){for(var b=0;0!=a;)b+=1,a>>>=1;return b};c.getBCHTypeInfo=function(a){for(var c=a<<10;0<=b(c)-b(1335);)c^=1335<<b(c)-b(1335);return(a<<10|c)^21522};c.getBCHTypeNumber=function(a){for(var c=a<<12;0<=b(c)-b(7973);)c^=7973<<b(c)-b(7973);return a<<12|c};c.getPatternPosition=function(b){return a[b-1]};c.getMaskFunction=function(a){switch(a){case 0:return function(a,b){return 0==(a+b)%2};case 1:return function(a){return 0==a%2};case 2:return function(a,b){return 0==b%3};case 3:return function(a,b){return 0==(a+b)%3};case 4:return function(a,b){return 0==(Math.floor(a/2)+Math.floor(b/3))%2};case 5:return function(a,b){return 0==a*b%2+a*b%3};case 6:return function(a,b){return 0==(a*b%2+a*b%3)%2};case 7:return function(a,b){return 0==(a*b%3+(a+b)%2)%2};default:throw Error("bad maskPattern:"+a);}};c.getErrorCorrectPolynomial=function(a){for(var b=D([1],0),c=0;c<a;c+=1)b=b.multiply(D([1,l.gexp(c)],0));return b};c.getLengthInBits=function(a,b){if(4==a)switch(!0){case 1<=b&&10>b:return 8;case 10<=b&&27>b:return 16;case 27<=b&&41>b:return 16;default:throw Error("type:"+a+" no:"+b);}else throw Error("mode:"+a);};return c}(),l=function(){for(var a=Array(256),c=Array(256),b=0;8>b;b+=1)a[b]=1<<b;for(b=8;256>b;b+=1)a[b]=a[b-4]^a[b-5]^a[b-6]^a[b-8];for(b=0;255>b;b+=1)c[a[b]]=b;return{glog:function(a){if(1>a)throw Error("glog("+a+")");return c[a]},gexp:function(b){for(;0>b;)b+=255;for(;256<=b;)b-=255;return a[b]}}}(),D=function(a,c){if("undefined"==typeof a.length)throw Error(a.length+"/"+c);var b=function(){for(var b=0;b<a.length&&0==a[b];)b+=1;for(var d=Array(a.length-b+c),e=0;e<a.length-b;e+=1)d[e]=a[e+b];return d}(),d={};d.getAt=function(a){return b[a]};d.getLength=function(){return b.length};d.multiply=function(a){for(var c=Array(d.getLength()+a.getLength()-1),e=0;e<d.getLength();e+=1)for(var f=0;f<a.getLength();f+=1)c[e+f]^=l.gexp(l.glog(d.getAt(e))+l.glog(a.getAt(f)));return D(c,0)};d.mod=function(a){if(0>d.getLength()-a.getLength())return d;for(var b=l.glog(d.getAt(0))-l.glog(a.getAt(0)),c=Array(d.getLength()),e=0;e<d.getLength();e+=1)c[e]=d.getAt(e);for(e=0;e<a.getLength();e+=1)c[e]^=l.gexp(l.glog(a.getAt(e))+b);return D(c,0).mod(a)};return d},A=function(){var a=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],c={};c.getRSBlocks=function(b,c){c={L:0,M:1,Q:2,H:3}[c];if("undefined"==typeof c)throw Error("bad rs block @ typeNumber:"+b+"/errorCorrectionLevel:"+c);b=a[4*(b-1)+c];c=[];for(var d=0;d<b.length;d+=3){var e=b[d],f=b[d+1],g=b[d+2];for(f=0;f<e;f+=1)c.push({totalCount:b[d+1],dataCount:g})}return c};return c}(),B=function(){var a=[],c=0,b={};b.getBuffer=function(){return a};b.getAt=function(b){return 1==(a[Math.floor(b/8)]>>>7-b%8&1)};b.put=function(a,c){for(var d=0;d<c;d+=1)b.putBit(1==(a>>>c-d-1&1))};b.getLengthInBits=function(){return c};b.putBit=function(b){var d=Math.floor(c/8);a.length<=d&&a.push(0);b&&(a[d]|=128>>>c%8);c+=1};return b},F=function(a){for(var b=0,d=0,e=0;8>e;e+=1){f(a,!1,e);var g=k;for(var h=0,l=0;l<g;l+=1)for(var m=0;m<g;m+=1){for(var n=!1,q=l-1;l+1>=q;q+=1)for(var r=m-1;m+1>=r;r+=1)0<=q&&q<g&&0<=r&&r<g?n=p.isDark(q,r):n=!1;p.isDark(l,m)==n&&(h+=1)}g=h;h=0;for(l=0;l<p.getModuleCount();l+=1)for(m=0;m<p.getModuleCount()-1;m+=1)n=p.isDark(l,m),n==p.isDark(l,m+1)&&(h+=1);g+=3*h;h=0;for(l=0;l<p.getModuleCount()-1;l+=1)for(m=0;m<p.getModuleCount()-1;m+=1)n=0,p.isDark(l,m)&&(n+=1),p.isDark(l+1,m)&&(n+=1),p.isDark(l,m+1)&&(n+=1),p.isDark(l+1,m+1)&&(n+=1),0!=n&&4!=n||(h+=1);g+=3*h;h=0;for(l=0;l<p.getModuleCount();l+=1)for(m=0;m<p.getModuleCount()-6;m+=1)p.isDark(l,m)&&!p.isDark(l,m+1)&&p.isDark(l,m+2)&&p.isDark(l,m+3)&&p.isDark(l,m+4)&&!p.isDark(l,m+5)&&p.isDark(l,m+6)&&(h+=1);for(l=0;l<p.getModuleCount();l+=1)for(m=0;m<p.getModuleCount()-6;m+=1)p.isDark(m,l)&&!p.isDark(m+1,l)&&p.isDark(m+2,l)&&p.isDark(m+3,l)&&p.isDark(m+4,l)&&!p.isDark(m+5,l)&&p.isDark(m+6,l)&&(h+=1);g+=40*h;h=0;for(l=0;l<p.getModuleCount();l+=1)for(m=0;m<p.getModuleCount();m+=1)p.isDark(l,m)&&(h+=1);g+=10*(Math.abs(100*h/p.getModuleCount()/p.getModuleCount()-50)/5);0==e||g<b?(b=g,d=e):b==g&&(d=Math.min(d,e))}return d};var p=null;return f}();
  // Render QR code
  var token = {{ token | tojson }};
  var qr = qrcode(0, 'M');
  qr.addData(token);
  qr.make();
  var canvas = document.getElementById('qr-canvas');
  var size = qr.getModuleCount();
  var cellSize = 4;
  var margin = 16;
  var totalSize = size * cellSize + 2 * margin;
  canvas.width = totalSize;
  canvas.height = totalSize;
  var ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, totalSize, totalSize);
  ctx.fillStyle = '#000000';
  for (var r = 0; r < size; r++) {
    for (var c = 0; c < size; c++) {
      if (qr.isDark(r, c)) {
        ctx.fillRect(c * cellSize + margin, r * cellSize + margin, cellSize, cellSize);
      }
    }
  }
})();
</script>
{% endblock %}
