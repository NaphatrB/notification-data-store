{% extends "base.html" %}

{% block title %}Token Issued — ANLA Admin{% endblock %}

{% block content %}
<h1>Token Issued</h1>

<div class="card">
  <p style="margin-bottom: 0.75rem;">
    <strong>Device:</strong> {{ device_name or device_uuid }}
  </p>
  <p style="margin-bottom: 0.75rem;">
    <strong>Action:</strong> {{ action }}
  </p>

  <div style="background: rgba(251,191,36,0.1); border: 1px solid var(--yellow); border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem;">
    <p style="color: var(--yellow); font-size: 0.85rem; font-weight: 600;">⚠️ Copy this token now — or scan the QR code. It will not be shown again.</p>
  </div>

  <div style="display: flex; gap: 1.5rem; align-items: flex-start; flex-wrap: wrap;">
    <div style="flex: 1; min-width: 250px;">
      <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.4rem;">Bearer Token</p>
      <div class="token-box">{{ token }}</div>
    </div>
    <div style="flex-shrink: 0; text-align: center;">
      <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.4rem;">Scan with device</p>
      <canvas id="qr-canvas" style="border-radius: 8px; background: #fff; padding: 12px;"></canvas>
    </div>
  </div>
</div>

<p class="mt-2"><a href="/admin/devices/{{ device_id }}" class="btn btn-primary">Continue to Device</a></p>

<script>
// Load QR code library from CDN, then render
(function(){
  var script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js';
  script.onload = function() {
    var token = {{ token | tojson }};
    var qr = qrcode(0, 'M');
    qr.addData(token);
    qr.make();
    var canvas = document.getElementById('qr-canvas');
    var size = qr.getModuleCount();
    var cellSize = 4;
    var margin = 16;
    var totalSize = size * cellSize + 2 * margin;
    canvas.width = totalSize;
    canvas.height = totalSize;
    var ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, totalSize, totalSize);
    ctx.fillStyle = '#000000';
    for (var r = 0; r < size; r++) {
      for (var c = 0; c < size; c++) {
        if (qr.isDark(r, c)) {
          ctx.fillRect(c * cellSize + margin, r * cellSize + margin, cellSize, cellSize);
        }
      }
    }
  };
  script.onerror = function() {
    document.getElementById('qr-canvas').style.display = 'none';
    var el = document.createElement('p');
    el.textContent = 'QR code unavailable — copy the token manually.';
    el.style.color = '#888';
    document.getElementById('qr-canvas').parentNode.appendChild(el);
  };
  document.head.appendChild(script);
})();
</script>
{% endblock %}
