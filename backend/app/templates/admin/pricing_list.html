{% extends "base.html" %}

{% block title %}Pricing Data ‚Äî ANLA Admin{% endblock %}

{% block content %}
<div class="container-wide" style="max-width:1280px; margin:0 auto;">
<h1>Pricing Data</h1>

<form id="pricing-filters" class="filter-bar">
  <div class="filter-group">
    <label for="q">Search</label>
    <input type="text" name="q" id="q" placeholder="sender, supplier, size, grade‚Ä¶" style="min-width:180px;">
  </div>

  <div class="filter-group">
    <label for="sender">Sender</label>
    <select name="sender" id="sender">
      <option value="">All</option>
      {% for sn in senders %}
      <option value="{{ sn }}">{{ sn }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="filter-group">
    <label for="supplier">Supplier</label>
    <select name="supplier" id="supplier">
      <option value="">All</option>
      {% for s in suppliers %}
      <option value="{{ s }}">{{ s }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="filter-group">
    <label for="currency">Currency</label>
    <select name="currency" id="currency">
      <option value="">All</option>
      {% for c in currencies %}
      <option value="{{ c }}">{{ c }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="filter-group">
    <label for="parserVersion">Parser Ver</label>
    <select name="parserVersion" id="parserVersion">
      <option value="">All</option>
      {% for pv in parser_versions %}
      <option value="{{ pv }}">{{ pv }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="filter-group">
    <label for="minPrice">Min $/kg</label>
    <input type="number" name="minPrice" id="minPrice" step="0.01" placeholder="‚Äî" style="width:90px;">
  </div>

  <div class="filter-group">
    <label for="maxPrice">Max $/kg</label>
    <input type="number" name="maxPrice" id="maxPrice" step="0.01" placeholder="‚Äî" style="width:90px;">
  </div>

  <div class="filter-group">
    <label for="from">From</label>
    <input type="datetime-local" name="from" id="from">
  </div>

  <div class="filter-group">
    <label for="to">To</label>
    <input type="datetime-local" name="to" id="to">
  </div>

  <div class="filter-group">
    <label for="limit">Per Page</label>
    <select name="limit" id="limit">
      <option value="25">25</option>
      <option value="50" selected>50</option>
      <option value="100">100</option>
      <option value="200">200</option>
      <option value="500">500</option>
    </select>
  </div>

  <input type="hidden" name="offset" id="pricing-offset" value="0">

  <div class="filter-group">
    <label>&nbsp;</label>
    <button type="button" class="btn btn-primary"
            hx-get="/admin/pricing/table"
            hx-target="#pricing-table"
            hx-include="#pricing-filters"
            onclick="document.getElementById('pricing-offset').value='0'">
      Search
    </button>
  </div>

  <div class="filter-group">
    <label>&nbsp;</label>
    <a id="export-btn" href="/admin/pricing/export" class="btn btn-green" style="text-decoration:none;">
      ‚¨á CSV
    </a>
  </div>

  <div class="filter-group">
    <label>&nbsp;</label>
    <button type="button" class="btn" id="rerun-btn"
            style="background:#d35400; color:#fff; border:none;"
            onclick="confirmRerun()">
      üîÑ Rerun All
    </button>
  </div>

  <span class="htmx-indicator">Loading‚Ä¶</span>
</form>

{% if request.query_params.get('rerun') %}
<div class="alert alert-success" style="margin:12px 0; padding:10px 16px; background:#d4edda; border:1px solid #c3e6cb; border-radius:4px; color:#155724;">
  ‚úÖ Parser rerun triggered ‚Äî deleted {{ request.query_params.get('deleted', '?') }} prices and {{ request.query_params.get('dl', '?') }} dead letters. The parser will re-process all events on its next poll cycle.
</div>
{% endif %}

<div id="pricing-table"
     hx-get="/admin/pricing/table"
     hx-trigger="load"
     hx-include="#pricing-filters"
     hx-indicator=".htmx-indicator">
</div>
</div>

<script>
function confirmRerun() {
  if (confirm('‚ö†Ô∏è This will DELETE all parsed pricing data and dead letters, then reset the parser offset to 0.\n\nThe parser will re-process all raw events from scratch on its next poll cycle.\n\nContinue?')) {
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/parser/rerun';
    document.body.appendChild(form);
    form.submit();
  }
}

// Keep CSV export link in sync with filter values
document.getElementById('export-btn').addEventListener('click', function(e) {
  e.preventDefault();
  var form = document.getElementById('pricing-filters');
  var params = new URLSearchParams();
  form.querySelectorAll('select, input').forEach(function(el) {
    if (el.name && el.value && el.name !== 'offset' && el.name !== 'limit') {
      params.set(el.name, el.value);
    }
  });
  var qs = params.toString();
  window.location.href = '/admin/pricing/export' + (qs ? '?' + qs : '');
});
</script>
{% endblock %}
